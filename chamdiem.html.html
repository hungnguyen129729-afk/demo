
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>S·ªï C·ªù ƒê·ªè Online ‚Äì Nh·∫≠p vi ph·∫°m</title>
  <style>
    :root{
      --bg:#f7f7fb;
      --card:#ffffff;
      --text:#222;
      --muted:#6b7280;
      --primary:#ef4444;
      --accent:#2563eb;
      --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      color:var(--text); background:var(--bg);
      line-height:1.45;
    }
    header{
      position:sticky; top:0; z-index:5;
      background:var(--card); border-bottom:1px solid var(--border);
      padding:12px 20px; display:flex; align-items:center; gap:12px;
    }
    header .flag{
      width:28px; height:28px; border-radius:6px; background:var(--primary);
      display:inline-block;
      mask: none;
    }
    header h1{margin:0; font-size:20px}
    .container{max-width:1100px; margin:24px auto; padding:0 16px}
    .grid{display:grid; gap:16px}
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:14px; padding:16px;
      box-shadow: 0 1px 2px rgba(16,24,40,.05);
    }
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .col{flex:1 1 220px}
    label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
    select,input,textarea,button{
      width:100%; padding:10px 12px; border:1px solid var(--border);
      border-radius:10px; background:white; font-size:14px;
    }
    select:disabled,input:disabled,textarea:disabled{background:#f2f4f7}
    button{cursor:pointer; border:1px solid transparent}
    .btn-primary{background:var(--accent); color:white}
    .btn-ghost{background:white; border-color:var(--border);}
    .btn-danger{background:var(--primary); color:white}
    .toolbar{display:flex; gap:10px; flex-wrap:wrap}
    table{width:100%; border-collapse:collapse; font-size:14px}
    th,td{border-top:1px solid var(--border); padding:10px; text-align:left}
    thead th{border-top:none; color:#374151; font-weight:600; background:#fafafa}
    tfoot td{font-weight:700}
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#eef2ff; color:#3730a3}
    .right{ text-align:right }
    .muted{ color:var(--muted) }
    .pill{display:inline-flex; gap:6px; align-items:center; padding:4px 10px; border-radius:999px; background:#fee2e2; color:#b91c1c; font-size:12px}
    .small{font-size:12px}
    .sticky-actions{display:flex; justify-content:space-between; gap:8px; margin-top:10px; flex-wrap:wrap}
    .hint{font-size:12px; color:var(--muted)}
    .totals{display:flex; gap:8px; flex-wrap:wrap}
    .totals .card{flex:1 1 200px}
    .h2{margin:0 0 10px 0; font-size:18px}
  </style>
</head>
<body>
  <header>
    <span class="flag"></span>
    <h1>S·ªï C·ªù ƒê·ªè Online ‚Äì Nh·∫≠p vi ph·∫°m</h1>
  </header>

  <div class="container grid">
    <section class="card">
      <h2 class="h2">‚ûï Th√™m vi ph·∫°m</h2>
      <div class="row">
        <div class="col">
          <label>L·ªõp</label>
          <select id="lopSelect"></select>
        </div>
        <div class="col">
          <label>Danh m·ª•c</label>
          <select id="catSelect"></select>
        </div>
        <div class="col">
          <label>N·ªôi dung vi ph·∫°m</label>
          <select id="viPhamSelect"></select>
        </div>
        <div class="col">
          <label>ƒêi·ªÉm/ƒë∆°n v·ªã</label>
          <input id="diemInput" type="text" disabled />
          <div class="hint small" id="unitHint"></div>
        </div>
        <div class="col">
          <label>S·ªë l∆∞·ª£ng (HS/l·∫ßn)</label>
          <input id="soLuongInput" type="number" min="1" value="1"/>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="col">
          <label>Ghi ch√∫</label>
          <input id="ghiChuInput" type="text" placeholder="VD: 2 HS ƒÉn trong l·ªõp, gi·ªù ra ch∆°i..."/>
        </div>
      </div>
      <div class="sticky-actions">
        <div class="toolbar">
          <button class="btn-primary" id="btnAdd">Th√™m v√†o danh s√°ch</button>
          <button class="btn-ghost" id="btnReset">X√≥a form</button>
        </div>
        <div class="toolbar">
          <button class="btn-ghost" id="btnExport">Xu·∫•t CSV</button>
          <button class="btn-ghost" id="btnClearAll">X√≥a to√†n b·ªô</button>
        </div>
      </div>
      <div class="hint" style="margin-top:8px">
        ƒêi·ªÉm s·∫Ω t·ª± ƒë·ªông t√≠nh theo quy ƒë·ªãnh (theo l·ªõp/HS/l·∫ßn) d·ª±a tr√™n t√†i li·ªáu b·∫°n cung c·∫•p.
      </div>
    </section>

    <section class="totals">
      <div class="card">
        <div class="muted small">T·ªïng m·ª•c trong ng√†y</div>
        <div id="totalRows" style="font-size:24px; font-weight:700">0</div>
      </div>
      <div class="card">
        <div class="muted small">T·ªïng ƒëi·ªÉm (t·∫•t c·∫£ l·ªõp)</div>
        <div id="totalPoints" style="font-size:24px; font-weight:700">0</div>
      </div>
      <div class="card">
        <div class="muted small">L·ªõp b·ªã tr·ª´ nhi·ªÅu nh·∫•t</div>
        <div id="topClass" style="font-size:18px; font-weight:700">‚Äî</div>
      </div>
    </section>

    <section class="card">
      <h2 class="h2">üìã Danh s√°ch vi ph·∫°m trong ng√†y</h2>
      <div class="row" style="margin-bottom:8px">
        <div class="col"><label>L·ªçc theo l·ªõp</label><select id="filterClass"></select></div>
        <div class="col"><label>T√¨m ki·∫øm</label><input id="searchBox" type="text" placeholder="Nh·∫≠p t·ª´ kh√≥a..."/></div>
      </div>
      <div style="overflow:auto">
        <table id="table">
          <thead>
            <tr>
              <th>Th·ªùi gian</th>
              <th>L·ªõp</th>
              <th>Danh m·ª•c</th>
              <th>N·ªôi dung</th>
              <th class="right">S·ªë l∆∞·ª£ng</th>
              <th class="right">ƒêi·ªÉm</th>
              <th>Ghi ch√∫</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td colspan="5">T·ªïng</td>
              <td class="right" id="tfootPoints">0</td>
              <td colspan="2"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>
  </div>

  <script>
  // ======= D·ªÆ LI·ªÜU QUY ƒê·ªäNH (r√∫t g·ªçn theo t√†i li·ªáu, c√≥ th·ªÉ m·ªü r·ªông th√™m) =======
  // unit: 'lop' = √°p cho c·∫£ l·ªõp/1 l·∫ßn ghi, 'hs' = theo h·ªçc sinh, 'lan' = theo l·∫ßn
  const RULES = {
    "N·ªÅ n·∫øp 15 ph√∫t ƒë·∫ßu gi·ªù": [
      {name:"C√≥ tr·ªëng m√† l·ªõp v·∫´n ·ªü ngo√†i", point:-10, unit:"lop"},
      {name:"L·ªõp kh√¥ng t·ªï ch·ª©c sinh ho·∫°t", point:-10, unit:"lop"},
      {name:"HS ra ngo√†i kh√¥ng nhi·ªám v·ª•", point:-2, unit:"hs"},
      {name:"Sinh ho·∫°t ·ªìn, sai ch·ªß ƒë·ªÅ, nhi·ªÅu l·∫ßn", point:-5, unit:"lop"},
    ],
    "V·ªá sinh": [
      {name:"KhƒÉn b√†n, b√¨nh hoa, r∆°i r√°c", point:-2, unit:"lop"},
      {name:"Tr·ª±c nh·∫≠t ch·∫≠m / v·ªá sinh b·∫©n trong l·ªõp", point:-5, unit:"lop"},
      {name:"V·ªá sinh b·∫©n tr∆∞·ªõc/sau l·ªõp, c·∫ßu thang", point:-5, unit:"lop"},
      {name:"HS mang ƒë·ªì ƒÉn v√†o l·ªõp", point:-5, unit:"hs"},
      {name:"ƒÇn xong kh√¥ng d·ªçn", point:-5, unit:"hs"},
    ],
    "Chuy√™n c·∫ßn": [
      {name:"HS ƒëi tr·ªÖ", point:-2, unit:"hs"},
      {name:"V·∫Øng kh√¥ng ph√©p", point:-3, unit:"hs"},
      {name:"V·∫Øng c√≥ ph√©p", point:-1, unit:"hs"},
      {name:"B·ªè gi·ªù", point:-10, unit:"hs"},
      {name:"B√°o c√°o gian l·∫≠n", point:-20, unit:"lop"},
    ],
    "T√°c phong": [
      {name:"Kh√¥ng ƒëeo b·∫£ng t√™n/kh√¥ng ƒë·ªìng ph·ª•c", point:-2, unit:"hs"},
      {name:"ƒêo√†n vi√™n kh√¥ng ƒëeo huy hi·ªáu", point:-2, unit:"hs"},
      {name:"Nam t√≥c kh√¥ng ƒë√∫ng quy ƒë·ªãnh (nhu·ªôm/u·ªën...)", point:-5, unit:"hs"},
      {name:"N·ªØ t√≥c/son/m√≥ng tay kh√¥ng ƒë√∫ng quy ƒë·ªãnh", point:-5, unit:"hs"},
      {name:"Mang d√©p kh√¥ng quai sau/kh√¥ng ƒë√∫ng quy ƒë·ªãnh", point:-2, unit:"hs"},
      {name:"B·ªè √°o ra ngo√†i qu·∫ßn", point:-1, unit:"hs"},
    ],
    "Ch√†o c·ªù": [
      // T√†i li·ªáu n√™u 1 m·ª•c ch∆∞a r√µ ƒëi·ªÉm; ch·ªâ ƒë∆∞a c√°c m·ª•c c√≥ ƒëi·ªÉm r√µ
      {name:"X·∫øp h√†ng ch·∫≠m", point:-10, unit:"lop"},
      {name:"M·∫•t tr·∫≠t t·ª± trong gi·ªù ch√†o c·ªù (m·ªói HS)", point:-1, unit:"hs"},
      {name:"B·ªè gh·∫ø l·∫°i s√¢n tr∆∞·ªùng", point:-5, unit:"lop"},
      {name:"B·ªè ch√†o c·ªù", point:-8, unit:"hs"},
    ],
    "ATGT & PC TNXH": [
      {name:"ƒêi xe trong s√¢n tr∆∞·ªùng l·∫°ng l√°ch/ƒë√°nh v√µng...", point:-10, unit:"hs"},
      {name:"H√∫t thu·ªëc/u·ªëng r∆∞·ª£u/c·ªù b·∫°c...", point:-25, unit:"hs"},
      {name:"T·ª• t·∫≠p g√¢y c·∫£n tr·ªü giao th√¥ng", point:-10, unit:"hs"},
      {name:"Leo t∆∞·ªùng/ƒë√°nh nhau/tr·ªôm c·∫Øp", point:-25, unit:"hs"},
    ],
    "Vi ph·∫°m kh√°c": [
      {name:"Vi ph·∫°m ki·ªÉm tra, thi c·ª≠", point:-10, unit:"hs"},
      {name:"L·∫•y gh·∫ø l·ªõp kh√°c ng·ªìi", point:-5, unit:"hs"},
      {name:"ƒêi v·ªá sinh kh√¥ng ƒë√∫ng n∆°i quy ƒë·ªãnh", point:-5, unit:"hs"},
      {name:"ƒê·ªï r√°c kh√¥ng ƒë√∫ng n∆°i quy ƒë·ªãnh", point:-5, unit:"lop"},
      {name:"L√†m h·ªèng b√†n gh·∫ø, kh√¥ng t·∫Øt ƒëi·ªán/qu·∫°t, d·∫´m t∆∞·ªùng", point:-10, unit:"lop"},
      {name:"Kh√¥ng kh√≥a c·ª≠a ch√≠nh khi ra kh·ªèi l·ªõp", point:-5, unit:"lop"},
      {name:"Kh√¥ng ƒë√≥ng c·ª≠a s·ªï", point:-2, unit:"lan"},
      {name:"La h√©t, ch·∫°y nh·∫£y, g√¢y m·∫•t tr·∫≠t t·ª±", point:-5, unit:"hs"},
      {name:"Ng·ªß trong gi·ªù h·ªçc", point:-3, unit:"hs"},
      {name:"D√πng ƒëi·ªán tho·∫°i trong gi·ªù h·ªçc/SH 15'", point:-10, unit:"hs"},
      {name:"Mang ch√¨a kh√≥a v·ªÅ nh√†", point:-10, unit:"lop"},
      {name:"ƒê·ªÉ ch√¨a kh√≥a kh√¥ng ƒë√∫ng v·ªã tr√≠", point:-3, unit:"lop"},
      {name:"Ra ngo√†i khu v·ª±c tr∆∞·ªùng kh√¥ng l√Ω do/kh√¥ng xin ph√©p", point:-5, unit:"hs"},
      {name:"L·ªõp tr·ª±c kh√¥ng c·∫≠p nh·∫≠t ƒë·ªß n·ªôi dung v√†o s·ªï ch√≠nh", point:-10, unit:"lop"},
      {name:"BCH Chi ƒëo√†n/Chi h·ªôi v·∫Øng h·ªçp c√≥ ph√©p", point:-2, unit:"lop"},
      {name:"BCH Chi ƒëo√†n/Chi h·ªôi v·∫Øng h·ªçp kh√¥ng ph√©p", point:-5, unit:"lop"},
      {name:"V√¥ l·ªÖ v·ªõi gi√°o vi√™n", point:-25, unit:"hs"},
      {name:"Kh√¥ng t√¥n tr·ªçng c·ªù ƒë·ªè", point:-5, unit:"lan"},
      {name:"C·ªù ƒë·ªè l·ªõp b·ªè tr·ª±c/kh√¥ng nghi√™m t√∫c/kh√¥ng ho√†n th√†nh", point:-10, unit:"lop"},
    ],
  };

  // ======= L·ªöP M·∫∂C ƒê·ªäNH (c√≥ th·ªÉ ch·ªânh trong UI) =======
  const CLASSES = ["10A1","10A2","10A3","10A4","10A5","10A6","10A7","11A1","11A2","11A3","11A4","11A5","11A6","11A7","11A8","11A9","11A10","11A11","12A1","12A2","12A3","12A4","12A5","12A6","12A7","12A8","12A9","12A10"];

  // ======= STATE =======
  const state = {
    rows: JSON.parse(localStorage.getItem("scdo_rows") || "[]"),
    filterClass: "ALL",
    search: ""
  };

  // ======= HELPER =======
  const $ = (s)=>document.querySelector(s);
  const fmt = (n)=> (n<=0? n : "+"+n);
  const nowStr = ()=> new Date().toLocaleString("vi-VN");

  function save(){
    localStorage.setItem("scdo_rows", JSON.stringify(state.rows));
  }

  // ======= INIT CONTROLS =======
  function initControls(){
    const lopSel = $("#lopSelect");
    const filterSel = $("#filterClass");
    lopSel.innerHTML = CLASSES.map(c=>`<option value="${c}">${c}</option>`).join("");
    filterSel.innerHTML = `<option value="ALL">T·∫•t c·∫£</option>` + CLASSES.map(c=>`<option value="${c}">${c}</option>`).join("");

    const catSel = $("#catSelect");
    catSel.innerHTML = Object.keys(RULES).map(k=>`<option value="${k}">${k}</option>`).join("");

    catSel.addEventListener("change", onCategoryChange);
    $("#viPhamSelect").addEventListener("change", onViolationChange);
    $("#soLuongInput").addEventListener("input", refreshPointPreview);
    onCategoryChange();
  }

  function onCategoryChange(){
    const cat = $("#catSelect").value;
    const list = RULES[cat] || [];
    $("#viPhamSelect").innerHTML = list.map((v,i)=>`<option value="${i}">${v.name}</option>`).join("");
    onViolationChange();
  }

  function onViolationChange(){
    const {point, unit} = getSelectedRule();
    $("#diemInput").value = fmt(point);
    $("#unitHint").textContent = unit==="hs" ? "ƒê∆°n v·ªã: m·ªói h·ªçc sinh"
                           : unit==="lop" ? "ƒê∆°n v·ªã: theo l·ªõp/l·∫ßn ghi"
                           : "ƒê∆°n v·ªã: theo l·∫ßn (m·ªói l·∫ßn √°p d·ª•ng ƒëi·ªÉm)";
    refreshPointPreview();
  }

  function getSelectedRule(){
    const cat = $("#catSelect").value;
    const idx = +$("#viPhamSelect").value || 0;
    const rule = (RULES[cat]||[])[idx];
    return rule || {point:0, unit:"lan"};
  }

  function refreshPointPreview(){
    const sl = Math.max(1, +$("#soLuongInput").value || 1);
    const {point, unit} = getSelectedRule();
    const total = unit==="hs" ? point*sl : unit==="lan" ? point*sl : point; // 'lop' ignores count
    $("#diemInput").value = fmt(total);
  }

  // ======= RENDER TABLE =======
  function render(){
    const tbody = $("#table tbody");
    const filter = state.filterClass;
    const search = state.search.toLowerCase();
    let total = 0;
    tbody.innerHTML = state.rows
      .filter(r => filter==="ALL" || r.lop===filter)
      .filter(r => JSON.stringify(r).toLowerCase().includes(search))
      .map((r,idx)=>{
        total += r.total;
        return `<tr data-index="${idx}">
          <td>${r.time}</td>
          <td><span class="badge">${r.lop}</span></td>
          <td>${r.cat}</td>
          <td>${r.name}</td>
          <td class="right">${r.soLuong}</td>
          <td class="right"><span class="pill">${r.total}</span></td>
          <td>${r.note||""}</td>
          <td class="right"><button class="btn-danger small" onclick="deleteRow(${idx})">X√≥a</button></td>
        </tr>`;
      }).join("");

    $("#tfootPoints").textContent = total;
    $("#totalPoints").textContent = total;
    $("#totalRows").textContent = state.rows.length;

    // top class summary
    const byClass = {};
    state.rows.forEach(r => { byClass[r.lop] = (byClass[r.lop]||0) + r.total; });
    let top = "‚Äî", min = 0;
    Object.entries(byClass).forEach(([lop,pt])=>{
      if(pt < min){ min = pt; top = `${lop} (${pt})`; }
    });
    $("#topClass").textContent = top;
  }

  window.deleteRow = function(index){
    if(!confirm("X√≥a m·ª•c n√†y?")) return;
    state.rows.splice(index,1);
    save(); render();
  }

  // ======= EVENT HANDLERS =======
  $("#btnAdd").addEventListener("click", ()=>{
    const lop = $("#lopSelect").value;
    const cat = $("#catSelect").value;
    const idx = +$("#viPhamSelect").value || 0;
    const rule = RULES[cat][idx];
    const soLuong = Math.max(1, +$("#soLuongInput").value || 1);
    const note = $("#ghiChuInput").value.trim();

    if(!lop || !rule){ alert("Vui l√≤ng ch·ªçn L·ªõp v√† N·ªôi dung vi ph·∫°m."); return; }

    const total = (rule.unit==="hs" ? rule.point * soLuong : rule.unit==="lan" ? rule.point * soLuong : rule.point);

    state.rows.push({
      time: nowStr(),
      lop, cat,
      name: rule.name,
      unit: rule.unit,
      soLuong,
      pointPerUnit: rule.point,
      total,
      note
    });
    save(); render();
    // reset some inputs
    $("#soLuongInput").value = 1;
    $("#ghiChuInput").value = "";
    refreshPointPreview();
  });

  $("#btnReset").addEventListener("click", ()=>{
    $("#soLuongInput").value = 1;
    $("#ghiChuInput").value = "";
    $("#lopSelect").selectedIndex = 0;
    $("#catSelect").selectedIndex = 0;
    onCategoryChange();
  });

  $("#btnClearAll").addEventListener("click", ()=>{
    if(!confirm("X√≥a to√†n b·ªô m·ª•c ƒë√£ nh·∫≠p trong ng√†y?")) return;
    state.rows = [];
    save(); render();
  });

  $("#filterClass").addEventListener("change", (e)=>{
    state.filterClass = e.target.value;
    render();
  });

  $("#searchBox").addEventListener("input", (e)=>{
    state.search = e.target.value;
    render();
  });

  function exportCSV(){
    const header = ["Th·ªùi gian","L·ªõp","Danh m·ª•c","N·ªôi dung","S·ªë l∆∞·ª£ng","ƒêi·ªÉm/ƒë∆°n v·ªã","ƒê∆°n v·ªã","T·ªïng ƒëi·ªÉm","Ghi ch√∫"];
    const lines = [header.join(",")];
    state.rows.forEach(r=>{
      const row = [
        r.time, r.lop, r.cat, r.name, r.soLuong,
        r.pointPerUnit, r.unit, r.total, r.note ? r.note.replace(/,/g,";") : ""
      ].map(v=>`"${String(v).replace(/"/g,'""')}"`);
      lines.push(row.join(","));
    });
    const blob = new Blob([lines.join("\\n")], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "so_co_do_nhap_vi_pham.csv";
    document.body.appendChild(a); a.click();
    document.body.removeChild(a); URL.revokeObjectURL(url);
  }
  $("#btnExport").addEventListener("click", exportCSV);

  // Boot
  initControls();
  render();
  </script>

  <!-- ====== KI·ªÇM TRA ƒêƒÇNG NH·∫¨P ====== -->
  <script>
  const currentUser = JSON.parse(localStorage.getItem("currentUser") || "null");
  if (!currentUser) {
    alert("Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc!");
    window.location.href = "account.html";
  } else {
    if (currentUser.role === "student") {
      const directClasses = JSON.parse(localStorage.getItem("directClasses") || "[]");
      if (!directClasses.includes(currentUser.class)) {
        const addSection = document.querySelector(".container .card");
        if (addSection) addSection.style.display = "none";
        alert(`L·ªõp ${currentUser.class} ƒëang ·ªü ch·∫ø ƒë·ªô xem, kh√¥ng ƒë∆∞·ª£c nh·∫≠p vi ph·∫°m.`);
      }
    }
  }
  </script>

</body>
</html>
